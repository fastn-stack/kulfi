name: ğŸ¯ Critical malai Infrastructure Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'malai/**'
      - 'malai-cli-test-utils/**'
      - 'test-e2e.sh'
      - 'Cargo.toml'
      - 'Cargo.lock'
  pull_request:
    branches: [ main ]
    paths:
      - 'malai/**'
      - 'malai-cli-test-utils/**'
      - 'test-e2e.sh'
      - 'Cargo.toml'
      - 'Cargo.lock'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  SKIP_KEYRING: true

jobs:
  critical-infrastructure-tests:
    name: ğŸ¯ Critical Infrastructure Pipeline Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target/
        key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential pkg-config

    - name: ğŸ”¨ Pre-compile malai Infrastructure Binaries
      run: |
        echo "ğŸ”¨ Pre-compiling malai infrastructure binaries..."
        echo "Building required binaries to isolate compilation time from test execution"
        
        echo "ğŸ“¦ Building malai..."
        time cargo build --bin malai
        
        echo "ğŸ“¦ Building test utilities..."
        time cargo build -p malai-cli-test-utils
        
        echo "âœ… All malai infrastructure binaries pre-compiled"
        echo "â±ï¸ Compilation time isolated from test execution"

    - name: ğŸ¯ Run Critical Infrastructure Tests
      run: |
        echo "ğŸ¯ Running malai critical infrastructure tests (PRE-COMPILED)"
        echo "These tests validate the complete distributed infrastructure:"
        echo "  - Role detection: cluster.toml vs machine.toml structure"
        echo "  - Real daemon: Multi-identity P2P listeners"
        echo "  - CLI integration: Self-command optimization + P2P execution"  
        echo "  - Config validation: TOML validation + design compliance"
        echo "  - P2P protocols: ConfigUpdate + ExecuteCommand end-to-end"
        echo "  - File structure: Design-compliant cluster.private-key structure"
        echo "  - Complete workflows: Cluster manager + machine coordination"
        echo
        echo "â±ï¸  Timing: This step measures PURE infrastructure performance"
        echo "â±ï¸  Compilation time excluded from this measurement"
        echo
        
        # Make test script executable
        chmod +x test-e2e.sh
        
        # Run comprehensive infrastructure test
        echo "ğŸ§ª Starting malai infrastructure tests at: $(date)"
        start_time=$(date +%s)
        
        timeout 600 ./test-e2e.sh || {
          echo "âŒ Tests failed or timed out after 10 minutes"
          exit 1
        }
        
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        echo "â±ï¸  Infrastructure tests completed in: ${duration} seconds"

    - name: ğŸ“Š Test Results Summary
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "ğŸ‰ âœ… CRITICAL INFRASTRUCTURE TESTS PASSED"
          echo "âœ… malai infrastructure tests completed successfully" 
          echo "ğŸ”§ Basic distributed infrastructure functionality validated"
        else
          echo "âŒ ğŸš¨ CRITICAL INFRASTRUCTURE TESTS FAILED"
          echo "âŒ malai infrastructure has critical issues"
          echo "ğŸ”§ Investigate distributed system problems before proceeding"
        fi