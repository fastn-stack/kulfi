name: Real Infrastructure P2P Test

on:
  # Run on pushes to infrastructure testing branches
  push:
    branches: 
      - feat/real-infrastructure-testing
      - main
  # Allow manual triggering
  workflow_dispatch:
  # Run weekly to catch regressions
  schedule:
    - cron: '0 10 * * 1'  # Every Monday at 10 AM UTC

jobs:
  real-infrastructure-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Full test including build takes ~30-40 minutes
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        
    - name: Run automated infrastructure test
      env:
        DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      run: |
        echo "üåê Starting automated real infrastructure P2P test"
        echo "This will validate malai P2P across real internet infrastructure"
        ./test-automated-infra.sh
        
    - name: Archive test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: infrastructure-test-logs
        path: /tmp/malai-auto-*/
        retention-days: 7